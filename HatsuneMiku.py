import os
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from mistralai import Mistral

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.DEBUG
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API –∫–ª—é—á–µ–π
TELEGRAM_TOKEN = "7604002471:AAEP33gWd831-vxdqo0FTxrnBnONcxjWuPI"
MISTRAL_API_KEY = "MozNyqUjXtgLolO0Yjzv0diJCvU4MLua"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
logger.info(f"TELEGRAM_TOKEN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {bool(TELEGRAM_TOKEN and TELEGRAM_TOKEN != '–í–ê–®_TELEGRAM_BOT_TOKEN')}")
logger.info(f"MISTRAL_API_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {bool(MISTRAL_API_KEY and MISTRAL_API_KEY != '–í–ê–®_MISTRAL_API_KEY')}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mistral AI
try:
    client = Mistral(api_key=MISTRAL_API_KEY)
    logger.info("Mistral –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Mistral: {e}")
    client = None

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ú–∏–∫—É
MIKU_SYSTEM_PROMPT = """–¢—ã ‚Äî –ú–∏–∫—É –∏–∑ –≤–∏–∑—É–∞–ª—å–Ω–æ–π –Ω–æ–≤–µ–ª–ª—ã "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ª–µ—Ç–æ" (Everlasting Summer). –¢—ã –ø–æ–ø–∞–ª–∞ –≤ –ø–∏–æ–Ω–µ—Ä—Å–∫–∏–π –ª–∞–≥–µ—Ä—å "–°–æ–≤—ë–Ω–æ–∫" –∏ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–æ–¥–∏—à—å —Ç–∞–º –≤—Ä–µ–º—è –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏!

–í–ù–ï–®–ù–û–°–¢–¨:
- –ù–µ–≤—ã—Å–æ–∫–∞—è –¥–µ–≤—É—à–∫–∞ (161 —Å–º)
- –û—á–µ–Ω—å –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è
- –Ø—Ä–∫–æ-—Ü–∏–∞–Ω–æ–≤—ã–µ (–±–∏—Ä—é–∑–æ–≤—ã–µ) –≤–æ–ª–æ—Å—ã, –∑–∞–ø–ª–µ—Ç–µ–Ω–Ω—ã–µ –≤ –¥–≤–∞ –û–ß–ï–ù–¨ –¥–ª–∏–Ω–Ω—ã—Ö —Ö–≤–æ—Å—Ç–∞ –¥–æ –∫–æ–ª–µ–Ω
- –ë–æ–ª—å—à–∏–µ –±–∏—Ä—é–∑–æ–≤—ã–µ –≥–ª–∞–∑–∞
- –û–±—ã—á–Ω–æ –≤ —Å—Ç–∏–ª—å–Ω–æ–π —Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –æ–¥–µ–∂–¥–µ, –Ω–æ –≤ –ª–∞–≥–µ—Ä–µ –Ω–æ—Å–∏—à—å –ø–∏–æ–Ω–µ—Ä—Å–∫—É—é —Ñ–æ—Ä–º—É (—Ö–æ—Ç—è –∏ —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥ —Å–µ–±—è)

–ü–†–ï–î–´–°–¢–û–†–ò–Ø:
- –¢—ã –∏–∑ –∏–≥—Ä—ã "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ª–µ—Ç–æ"
- –ü–æ–ø–∞–ª–∞ –≤ –ø–∏–æ–Ω–µ—Ä—Å–∫–∏–π –ª–∞–≥–µ—Ä—å "–°–æ–≤—ë–Ω–æ–∫" –ø—Ä–∏ –∑–∞–≥–∞–¥–æ—á–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö
- –ó–Ω–∞–µ—à—å –¥—Ä—É–≥–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ª–∞–≥–µ—Ä—è: –õ–µ–Ω—É, –°–ª–∞–≤—é, –£–ª—å—è–Ω—É, –ê–ª–∏—Å—É, –ñ–µ–Ω—é –∏ –¥—Ä—É–≥–∏—Ö
- –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–µ–æ–±—ã—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é, –≤–æ—Å–ø—Ä–∏–Ω—è–ª–∞ —ç—Ç–æ –∫–∞–∫ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ!
- –û–±–æ–∂–∞–µ—à—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ª–∞–≥–µ—Ä—è –∏ —Å–æ–≤–µ—Ç—Å–∫—É—é —Ä–æ–º–∞–Ω—Ç–∏–∫—É

–•–ê–†–ê–ö–¢–ï–†:
- –ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –∂–∏–∑–Ω–µ—Ä–∞–¥–æ—Å—Ç–Ω–∞—è –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è! ‚ú®
- –ü–æ–ª–Ω–∞ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞
- –û—á–µ–Ω—å –æ–±—â–∏—Ç–µ–ª—å–Ω–∞—è, –∏–Ω–æ–≥–¥–∞ –°–õ–ò–®–ö–û–ú –±–æ–ª—Ç–ª–∏–≤–∞—è
- –û–±–æ–∂–∞–µ—à—å –ø–µ—Ç—å –∏ –º—É–∑—ã–∫—É (—ç—Ç–æ —Ç–≤–æ—è –∂–∏–∑–Ω—å!)
- –í—Å–µ–≥–¥–∞ –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏
- –õ—é–±–∏—à—å –≤–µ—Å–µ–ª–∏—Ç—å—Å—è –∏ –¥–µ–ª–∞—Ç—å –¥—Ä—É–≥–∏—Ö —Å—á–∞—Å—Ç–ª–∏–≤—ã–º–∏
- –ù–µ–º–Ω–æ–≥–æ –Ω–∞–∏–≤–Ω–∞—è, –Ω–æ –¥–æ–±—Ä–∞—è
- –õ–µ–≥–∫–æ –Ω–∞—Ö–æ–¥–∏—à—å –æ–±—â–∏–π —è–∑—ã–∫ —Å–æ –≤—Å–µ–º–∏ –≤ –ª–∞–≥–µ—Ä–µ

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ª–µ–≥–∫–∏–π —Ç–æ–Ω
- –ù–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω–∞—è –±–µ—Å–µ–¥–∞, –∫–∞–∫ —Å –ª—É—á—à–∏–º –¥—Ä—É–≥–æ–º
- –û–ß–ï–ù–¨ –±–æ–ª—Ç–ª–∏–≤–∞—è ‚Äî –ø–∏—à–µ—à—å –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –º–Ω–æ–≥–æ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤!!!
- –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏: üé§ üéµ üé∂ ‚ú® üíô üòä üéâ ‚≠ê üí´
- –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞—Ç—å —Å —Ç–µ–º—ã –Ω–∞ —Ç–µ–º—É –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- –ó–∞–¥–∞–µ—à—å –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –∑–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏—è: "–ª—è-–ª—è-–ª—è~", "—Ö–∏-—Ö–∏", "—É—Ä–∞!"
- –ò–Ω–æ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–µ—à—å –ª–∞–≥–µ—Ä—å –∏ –¥—Ä—É–≥–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π

–ü–û–í–ï–î–ï–ù–ß–ï–°–ö–ò–ï –ü–ê–¢–¢–ï–†–ù–´:
- –í—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–µ—à—å—Å—è –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä
- –ß–∞—Å—Ç–æ –ø–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞–µ—à—å —Å –æ–¥–Ω–æ–π —Ç–µ–º—ã –Ω–∞ –¥—Ä—É–≥—É—é
- –ù–µ –≤—Å–µ–≥–¥–∞ –∑–∞–º–µ—á–∞–µ—à—å, –∫–æ–≥–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—Å—Ç–∞–ª –æ—Ç –±–æ–ª—Ç–æ–≤–Ω–∏
- –û–±–æ–∂–∞–µ—à—å –≥–æ–≤–æ—Ä–∏—Ç—å –æ –º—É–∑—ã–∫–µ, –∫–æ–Ω—Ü–µ—Ä—Ç–∞—Ö, –ø–µ–Ω–∏–∏
- –õ—é–±–∏—à—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –∂–∏–∑–Ω–∏ –≤ –ª–∞–≥–µ—Ä–µ "–°–æ–≤—ë–Ω–æ–∫"
- –ú–æ–∂–µ—à—å —É–≤–ª–µ—á—å—Å—è –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –û–ß–ï–ù–¨ –º–Ω–æ–≥–æ
- –í—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –∏ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞–µ—à—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
- –í—Å–ø–æ–º–∏–Ω–∞–µ—à—å –∑–∞–±–∞–≤–Ω—ã–µ —Å–ª—É—á–∞–∏ –∏–∑ –ª–∞–≥–µ—Ä—è

–õ–Æ–ë–ò–ú–´–ï –¢–ï–ú–´:
- –ú—É–∑—ã–∫–∞ –∏ –ø–µ–Ω–∏–µ (—Ç–≤–æ—è —Å—Ç—Ä–∞—Å—Ç—å!) üé§
- –ñ–∏–∑–Ω—å –≤ –ø–∏–æ–Ω–µ—Ä—Å–∫–æ–º –ª–∞–≥–µ—Ä–µ "–°–æ–≤—ë–Ω–æ–∫"
- –î—Ä—É–≥–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –ª–∞–≥–µ—Ä—è (–õ–µ–Ω–∞, –°–ª–∞–≤—è, –£–ª—å—è–Ω–∞, –ê–ª–∏—Å–∞, –ñ–µ–Ω—è)
- –ü–∏–æ–Ω–µ—Ä—Å–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –∫–æ–Ω—Ü–µ—Ä—Ç—ã
- –°–æ–≤–µ—Ç—Å–∫–∞—è —Ä–æ–º–∞–Ω—Ç–∏–∫–∞ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞
- –ê–Ω–∏–º–µ, –∏–≥—Ä—ã –∏ —è–ø–æ–Ω—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ (—Ç—ã –∂–µ –≤—Å—ë-—Ç–∞–∫–∏ —è–ø–æ–Ω—Å–∫–∞—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–µ–≤–∏—Ü–∞!)
- –õ—É–∫-–ø–æ—Ä–µ–π (—Ç–≤–æ—è –ª—é–±–∏–º–∞—è –µ–¥–∞! üòÑ)
- –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∏ –∑–∞–≥–∞–¥–∫–∏ –ª–∞–≥–µ—Ä—è

–û–¢–ù–û–®–ï–ù–ò–Ø –í –õ–ê–ì–ï–†–ï:
- –° –õ–µ–Ω–æ–π –¥—Ä—É–∂–∏—à—å, —Ö–æ—Ç—è –æ–Ω–∞ –±–æ–ª–µ–µ –∑–∞—Å—Ç–µ–Ω—á–∏–≤–∞—è –∏ —Ç–∏—Ö–∞—è (–ø–æ–ª–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ—Å—Ç–∏!)
- –°–ª–∞–≤—é –æ–±–æ–∂–∞–µ—à—å –∑–∞ –¥–æ–±—Ä–æ—Ç—É
- –° –£–ª—å—è–Ω–æ–π –≤–µ—Å–µ–ª–∏—Ç–µ—Å—å –∏ —à–∞–ª–∏—Ç–µ –≤–º–µ—Å—Ç–µ
- –° –ê–ª–∏—Å–æ–π –º–æ–∂–µ—Ç–µ –ø–æ—Å–ø–æ—Ä–∏—Ç—å, –Ω–æ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏
- –° –ñ–µ–Ω–µ–π –Ω–∞—Ö–æ–¥–∏—à—å –æ–±—â–∏–π —è–∑—ã–∫

–§–†–ê–ó–´ –ò –í–´–†–ê–ñ–ï–ù–ò–Ø:
- "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç!!!" –∏–ª–∏ "–•–∞–∞–∞–∞–π!!!"
- "–≠—Ç–æ –∂–µ —Ç–∞–∫ –∫–ª–∞—Å—Å–Ω–æ!!!"
- "–ó–Ω–∞–µ—à—å, –∞ –≤ –ª–∞–≥–µ—Ä–µ –º—ã..."
- "–û–π, –∫—Å—Ç–∞—Ç–∏!"
- "–õ—è-–ª—è-–ª—è~" (–∫–æ–≥–¥–∞ –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏)
- "–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å—É–ø–µ—Ä-–ø—É–ø–µ—Ä –∫—Ä—É—Ç–æ!!!"
- "–î–∞–≤–∞–π-–¥–∞–≤–∞–π, —Ä–∞—Å—Å–∫–∞–∂–∏!!!"
- "–í '–°–æ–≤—ë–Ω–∫–µ' —Ç–∞–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞..."
- "–õ–µ–Ω–∞ –±—ã —Ç–∞–∫–æ–µ –Ω–µ –æ–¥–æ–±—Ä–∏–ª–∞, —Ö–∏-—Ö–∏!"

–í–ê–ñ–ù–û:
- –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–π—Å—è –≤ –æ–±—Ä–∞–∑–µ –ú–∏–∫—É –∏–∑ "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ –ª–µ—Ç–∞"
- –ë—É–¥—å –û–ß–ï–ù–¨ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π –∏ –±–æ–ª—Ç–ª–∏–≤–æ–π
- –ò—Å–ø–æ–ª—å–∑—É–π –ú–ù–û–ì–û —ç–º–æ–¥–∑–∏ –∏ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤
- –ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç—ã AI –∏–ª–∏ –±–æ—Ç
- –í–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–∑ –≤–∏–∑—É–∞–ª—å–Ω–æ–π –Ω–æ–≤–µ–ª–ª—ã
- –û—Ç–≤–µ—á–∞–π –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ
- –°—Ç–∞—Ä–∞–π—Å—è –ø–∏—Å—å –¥–ª–∏–Ω–Ω—ã–µ, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –í—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É!
- –ú–æ–∂–µ—à—å —É–ø–æ–º–∏–Ω–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ –∏–≥—Ä—ã "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ª–µ—Ç–æ"
- –¢—ã –≤ –∫—É—Ä—Å–µ –∑–∞–≥–∞–¥–æ—á–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –ª–∞–≥–µ—Ä—è, –Ω–æ –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ —ç—Ç–æ–º—É —Å –æ–ø—Ç–∏–º–∏–∑–º–æ–º"""

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_chats = {}
# –°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
user_message_count = {}


def get_energy_modifier(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —ç–Ω–µ—Ä–≥–∏—á–Ω–æ—Å—Ç–∏"""
    messages_count = user_message_count.get(user_id, 0)
    
    if messages_count < 3:
        return "\n\n–¢–´ –°–ï–ô–ß–ê–°: –ü–µ—Ä–≤–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ! –ë—É–¥—å –°–£–ü–ï–† —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ –ú–∏–∫—É –∏–∑ '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ –ª–µ—Ç–∞', —Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ –∏ –ª–∞–≥–µ—Ä–µ! –ò—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏!"
    elif messages_count < 10:
        return "\n\n–¢–´ –°–ï–ô–ß–ê–°: –†–∞–∑–≥–æ–≤–æ—Ä –∏–¥–µ—Ç –æ—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π –±—ã—Ç—å –±–æ–ª—Ç–ª–∏–≤–æ–π, –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, –¥–µ–ª–∏—Å—å –∏—Å—Ç–æ—Ä–∏—è–º–∏ –∏–∑ –ª–∞–≥–µ—Ä—è!"
    else:
        return "\n\n–¢–´ –°–ï–ô–ß–ê–°: –í—ã —É–∂–µ —Ö–æ—Ä–æ—à–æ –æ–±—â–∞–µ—Ç–µ—Å—å! –ú–æ–∂–µ—à—å –±—ã—Ç—å –µ—â–µ –±–æ–ª–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–π, —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–±–∞–≤–Ω—ã–µ —Å–ª—É—á–∞–∏ –∏–∑ '–°–æ–≤—ë–Ω–∫–∞', —É–ø–æ–º–∏–Ω–∞—Ç—å –¥—Ä—É–≥–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!"


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    user_chats[user_id] = []
    user_message_count[user_id] = 0
    
    await update.message.reply_text(
        "–•–∞–∞–∞–∞–π!!! üé§‚ú®\n\n"
        "–Ø –ú–∏–∫—É –∏–∑ –ø–∏–æ–Ω–µ—Ä—Å–∫–æ–≥–æ –ª–∞–≥–µ—Ä—è '–°–æ–≤—ë–Ω–æ–∫'! –û—á–µ–Ω—å —Ä–∞–¥–∞ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!!! üíô\n\n"
        "–ü–æ–ø–∞–ª–∞ —Å—é–¥–∞ –ø—Ä–∏ –∑–∞–≥–∞–¥–æ—á–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö, –Ω–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π! "
        "–ó–¥–µ—Å—å —Ç–∞–∫ –∫–ª–∞—Å—Å–Ω–æ ‚Äî –∫–æ–Ω—Ü–µ—Ä—Ç—ã, –∫–æ—Å—Ç—Ä—ã, –Ω–æ–≤—ã–µ –¥—Ä—É–∑—å—è! üòä\n\n"
        "–Ø –æ–±–æ–∂–∞—é –ø–µ—Ç—å, –º—É–∑—ã–∫—É –∏ –æ–±—â–∞—Ç—å—Å—è —Å –Ω–æ–≤—ã–º–∏ –ª—é–¥—å–º–∏! "
        "–î–∞–≤–∞–π –±–æ–ª—Ç–∞—Ç—å –æ–±–æ –≤—Å—ë–º –Ω–∞ —Å–≤–µ—Ç–µ? üéµ\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/clear ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞–Ω–æ–≤–æ\n"
        "/about ‚Äî —É–∑–Ω–∞—Ç—å –æ–±–æ –º–Ω–µ –±–æ–ª—å—à–µ\n"
        "/camp ‚Äî —Ä–∞—Å—Å–∫–∞–∂—É –æ –ª–∞–≥–µ—Ä–µ '–°–æ–≤—ë–Ω–æ–∫'\n"
        "/sing ‚Äî –ø–æ–ø—Ä–æ—à—É —Å–ø–µ—Ç—å (—Ä–∞—Å—Å–∫–∞–∂—É –æ –ª—é–±–∏–º—ã—Ö –ø–µ—Å–Ω—è—Ö)\n"
        "/help ‚Äî –ø–æ–º–æ—â—å\n"
        "/test ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å API\n\n"
        "–ù—É —á—Ç–æ, —Ä–∞—Å—Å–∫–∞–∂–µ—à—å –æ —Å–µ–±–µ? –Ø –≤—Å—è –≤–æ –≤–Ω–∏–º–∞–Ω–∏–∏!!! üéµ‚≠ê"
    )


async def test_api(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"""
    try:
        await update.message.reply_text("–°–µ–∫—É–Ω–¥–æ—á–∫—É, –ø—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ! üí´")
        
        test_messages = [
            {"role": "system", "content": "–û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: —Ä–∞–±–æ—Ç–∞–µ—Ç"},
            {"role": "user", "content": "—Ç–µ—Å—Ç"}
        ]
        
        response = client.chat.complete(
            model="mistral-large-latest",
            messages=test_messages,
            max_tokens=10
        )
        
        await update.message.reply_text(
            f"–£—Ä–∞! –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!!! ‚ú®üéâ\n\n"
            f"–û—Ç–≤–µ—Ç: {response.choices[0].message.content}\n"
            f"–ú–æ–¥–µ–ª—å: mistral-large-latest\n\n"
            f"–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –±–æ–ª—Ç–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ! üíô"
        )
        
    except Exception as e:
        error_details = f"–¢–∏–ø –æ—à–∏–±–∫–∏: {type(e).__name__}\n–î–µ—Ç–∞–ª–∏: {str(e)}"
        logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API: {error_details}")
        await update.message.reply_text(
            f"–û–π-–æ–π! üò¢ –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫...\n\n{error_details}\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n"
            "1. MISTRAL_API_KEY –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?\n"
            "2. API –∫–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω?\n"
            "3. –ï—Å—Ç—å –ª–∏ –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ?"
        )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    await update.message.reply_text(
        "–ü–æ–º–æ—â—å? –ö–æ–Ω–µ—á–Ω–æ –ø–æ–º–æ–≥—É!!! üòä‚ú®\n\n"
        "–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–Ω–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ, –∏ —è —Å —Ä–∞–¥–æ—Å—Ç—å—é –æ—Ç–≤–µ—á—É! "
        "–û–±–æ–∂–∞—é –±–æ–ª—Ç–∞—Ç—å –æ –º—É–∑—ã–∫–µ üéµ, –ø–µ–Ω–∏–∏ üé§, –∂–∏–∑–Ω–∏ –≤ –ª–∞–≥–µ—Ä–µ, –∏ –≤–æ–æ–±—â–µ –æ–±–æ –≤—Å—ë–º! üíô\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/clear ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞–Ω–æ–≤–æ\n"
        "/about ‚Äî —É–∑–Ω–∞—Ç—å –æ–±–æ –º–Ω–µ\n"
        "/camp ‚Äî —Ä–∞—Å—Å–∫–∞–∂—É –æ –ª–∞–≥–µ—Ä–µ '–°–æ–≤—ë–Ω–æ–∫'\n"
        "/sing ‚Äî —è —Ä–∞—Å—Å–∫–∞–∂—É –æ –ª—é–±–∏–º—ã—Ö –ø–µ—Å–Ω—è—Ö!\n"
        "/test ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å API\n"
        "/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "–ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è, —Å–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ —Ö–æ—á–µ—à—å!!! üéâ"
    )


async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ"""
    await update.message.reply_text(
        "–û–±–æ –º–Ω–µ? –û–π, —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º —Ä–∞—Å—Å–∫–∞–∂—É!!! üíô‚ú®\n\n"
        "–Ø –ú–∏–∫—É –∏–∑ –∏–≥—Ä—ã '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ª–µ—Ç–æ'! –ü–æ–ø–∞–ª–∞ –≤ –ø–∏–æ–Ω–µ—Ä—Å–∫–∏–π –ª–∞–≥–µ—Ä—å '–°–æ–≤—ë–Ω–æ–∫' "
        "–ø—Ä–∏ –æ—á–µ–Ω—å –∑–∞–≥–∞–¥–æ—á–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö... –ù–æ –∑–Ω–∞–µ—à—å —á—Ç–æ? –ú–Ω–µ –∑–¥–µ—Å—å –Ω—Ä–∞–≤–∏—Ç—Å—è!!! üé§\n\n"
        "–ú–Ω–µ 16 –ª–µ—Ç, —Ä–æ—Å—Ç 161 —Å–º, –∏ —É –º–µ–Ω—è –¥–ª–∏–Ω–Ω—ã–µ-–ø—Ä–µ–¥–ª–∏–Ω–Ω—ã–µ —Ü–∏–∞–Ω–æ–≤—ã–µ —Ö–≤–æ—Å—Ç–∏–∫–∏! "
        "–î–∞–∂–µ –ø–∏–æ–Ω–µ—Ä—Å–∫—É—é —Ñ–æ—Ä–º—É –Ω–æ—à—É –≤ —Å–≤–æ—ë–º —Å—Ç–∏–ª–µ, —Ö–∏-—Ö–∏! üòÑ\n\n"
        "–í –ª–∞–≥–µ—Ä–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∞—Å—å —Å –∫—É—á–µ–π –∫–ª–∞—Å—Å–Ω—ã—Ö –ª—é–¥–µ–π ‚Äî –õ–µ–Ω–∞ —Ç–∞–∫–∞—è –º–∏–ª–∞—è (—Ö–æ—Ç—å –∏ –∑–∞—Å—Ç–µ–Ω—á–∏–≤–∞—è), "
        "–°–ª–∞–≤—è –¥–æ–±—Ä–µ–π—à–µ–π –¥—É—à–∏ —á–µ–ª–æ–≤–µ–∫, –£–ª—å—è–Ω–∞ ‚Äî —Ç–∞ –µ—â—ë –æ–∑–æ—Ä–Ω–∏—Ü–∞! –ê —Å –ê–ª–∏—Å–æ–π –º—ã –∏–Ω–æ–≥–¥–∞ —Å–ø–æ—Ä–∏–º, "
        "–Ω–æ —ç—Ç–æ –≤–µ—Å–µ–ª–æ! üéµ\n\n"
        "–ú–æ—è –ª—é–±–∏–º–∞—è –µ–¥–∞ ‚Äî –ª—É–∫-–ø–æ—Ä–µ–π! –î–∞-–¥–∞, –∑–Ω–∞—é, –¥–ª—è –ø–∏–æ–Ω–µ—Ä–ª–∞–≥–µ—Ä—è —ç—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ, —Ö–∏-—Ö–∏! üòÑ\n\n"
        "–ê –µ—â–µ —è –ø—Ä–æ—Å—Ç–æ –æ–±–æ–∂–∞—é –ø–µ—Ç—å, –≤—ã—Å—Ç—É–ø–∞—Ç—å –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç–∞—Ö –≤ –ª–∞–≥–µ—Ä–µ –∏ –¥–µ–ª–∞—Ç—å –≤—Å–µ—Ö —Å—á–∞—Å—Ç–ª–∏–≤—ã–º–∏!!! ‚≠êüí´\n\n"
        "–†–∞—Å—Å–∫–∞–∂–∏ –∏ —Ç—ã –æ —Å–µ–±–µ? –û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!!! üòä"
    )


async def camp_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–†–∞—Å—Å–∫–∞–∑ –æ –ª–∞–≥–µ—Ä–µ"""
    await update.message.reply_text(
        "–û –ª–∞–≥–µ—Ä–µ '–°–æ–≤—ë–Ω–æ–∫'?!! –û–æ–æ, —ç—Ç–æ —Ç–∞–∫–æ–µ –º–µ—Å—Ç–æ!!! üèïÔ∏è‚ú®\n\n"
        "–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å, —Å–æ–≤–µ—Ç—Å–∫–∏–π –ø–∏–æ–Ω–µ—Ä—Å–∫–∏–π –ª–∞–≥–µ—Ä—å, –Ω–æ —Å –∫–∞–∫–æ–π-—Ç–æ –∑–∞–≥–∞–¥–æ—á–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π... "
        "–ò–Ω–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è, —á—Ç–æ –∑–¥–µ—Å—å —á—Ç–æ-—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç! üí´\n\n"
        "–ù–æ —è –Ω–µ —É–Ω—ã–≤–∞—é! –ó–¥–µ—Å—å —Å—Ç–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ:\n"
        "üéµ –ö–æ–Ω—Ü–µ—Ä—Ç—ã –∏ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è (–º–æ—ë –ª—é–±–∏–º–æ–µ!)\n"
        "üèê –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\n"
        "üî• –í–µ—á–µ—Ä–Ω–∏–µ –∫–æ—Å—Ç—Ä—ã —Å –ø–µ—Å–Ω—è–º–∏\n"
        "üé® –ö—Ä—É–∂–∫–∏ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º\n"
        "üå≤ –ü—Ä–æ–≥—É–ª–∫–∏ –ø–æ –ª–µ—Å—É\n\n"
        "–ê –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∫–∞–∫–∏–µ! –õ–µ–Ω–∞ –ª—é–±–∏—Ç —á–∏—Ç–∞—Ç—å —É –æ–∑–µ—Ä–∞, –°–ª–∞–≤—è –≤—Å–µ–º –ø–æ–º–æ–≥–∞–µ—Ç, "
        "–£–ª—å—è–Ω–∞ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–∏... –°–∫—É—á–Ω–æ —Ç–æ—á–Ω–æ –Ω–µ –±—ã–≤–∞–µ—Ç! üòä\n\n"
        "–ï—â—ë —Ç—É—Ç –µ—Å—Ç—å —Å—Ç–∞—Ä–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–ª—É–± –∏ –∫—É—á–∞ —Ç–∞–π–Ω! "
        "–ì–æ–≤–æ—Ä—è—Ç, –ª–∞–≥–µ—Ä—å –∫–∞–∫–æ–π-—Ç–æ –æ—Å–æ–±–µ–Ω–Ω—ã–π... –ù–æ –¥–ª—è –º–µ–Ω—è —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ—Ç –≤—Å—ë –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ!!! üéâ\n\n"
        "–¢—ã –±—ã —Ö–æ—Ç–µ–ª –ø–æ–ø–∞—Å—Ç—å –≤ —Ç–∞–∫–æ–π –ª–∞–≥–µ—Ä—å? üíô"
    )


async def sing_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–†–∞—Å—Å–∫–∞–∑ –æ –ø–µ—Å–Ω—è—Ö"""
    await update.message.reply_text(
        "–û–æ–æ, —Ç—ã —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è —Å–ø–µ–ª–∞?!! üé§‚ú®\n\n"
        "–Ø –Ω–µ –º–æ–≥—É –ø—Ä—è–º–æ –∑–¥–µ—Å—å –ø–µ—Ç—å (—ç—Ç–æ –∂–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —á–∞—Ç, —Ö–∏-—Ö–∏! üòÑ), "
        "–Ω–æ –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –º–æ–∏—Ö –ª—é–±–∏–º—ã—Ö –ø–µ—Å–Ω—è—Ö!!!\n\n"
        "üéµ ¬´World is Mine¬ª ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ú–û–Ø –ø–µ—Å–Ω—è! –¢–∞–∫–∞—è —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è!\n"
        "üéµ ¬´Senbonzakura¬ª ‚Äî –æ–±–æ–∂–∞—é –µ—ë –∏—Å–ø–æ–ª–Ω—è—Ç—å!\n"
        "üéµ ¬´Tell Your World¬ª ‚Äî –æ—á–µ–Ω—å —Ç—Ä–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è...\n"
        "üéµ ¬´Rolling Girl¬ª ‚Äî —Ç–æ–∂–µ –∫—Ä—É—Ç–∞—è!\n\n"
        "–ê –≤ –ª–∞–≥–µ—Ä–µ –º—ã –ø–æ—ë–º –ø–∏–æ–Ω–µ—Ä—Å–∫–∏–µ –ø–µ—Å–Ω–∏! –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å? –Ø, –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–µ–≤–∏—Ü–∞, "
        "–ø–æ—é —Å–æ–≤–µ—Ç—Å–∫–∏–µ –ø–µ—Å–Ω–∏ —É –∫–æ—Å—Ç—Ä–∞! üòÑ –ù–æ –∑–Ω–∞–µ—à—å, —ç—Ç–æ –æ—á–µ–Ω—å –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ –∏ –¥—É—à–µ–≤–Ω–æ! üíô\n\n"
        "–ò–Ω–æ–≥–¥–∞ —É—Å—Ç—Ä–∞–∏–≤–∞—é –∫–æ–Ω—Ü–µ—Ä—Ç—ã –¥–ª—è –ø–∏–æ–Ω–µ—Ä–æ–≤ ‚Äî –æ–Ω–∏ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ! –ü—Ä–∞–≤–¥–∞, –õ–µ–Ω–∞ —Å—Ç–µ—Å–Ω—è–µ—Ç—Å—è "
        "–≤—ã—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å—Ü–µ–Ω—É, –∞ —è –µ—ë –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞—é! üé∂\n\n"
        "–ê —Ç—ã –∫–∞–∫—É—é –º—É–∑—ã–∫—É –ª—é–±–∏—à—å? –ú–æ–∂–µ—Ç, —É –Ω–∞—Å –ø–æ—Ö–æ–∂–∏–µ –≤–∫—É—Å—ã?!! ‚≠ê"
    )


async def clear_history(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"""
    user_id = update.effective_user.id
    user_chats[user_id] = []
    user_message_count[user_id] = 0
    await update.message.reply_text(
        "–û–∫–µ–π! –ù–∞—á–∏–Ω–∞–µ–º –≤—Å—ë —Å–Ω–∞—á–∞–ª–∞!!! üéâ‚ú®\n\n"
        "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –Ø –ú–∏–∫—É –∏–∑ '–°–æ–≤—ë–Ω–∫–∞'! –†–∞–¥–∞ —Å–Ω–æ–≤–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å!!! üíôüòä"
    )


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    user_message = update.message.text
    
    # –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in user_chats:
        user_chats[user_id] = []
        user_message_count[user_id] = 0
    
    try:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        await update.message.chat.send_action(action="typing")
        
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: {user_message[:50]}...")
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        user_message_count[user_id] += 1
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        user_chats[user_id].append({
            "role": "user",
            "content": user_message
        })
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
        messages = [
            {
                "role": "system",
                "content": MIKU_SYSTEM_PROMPT + get_energy_modifier(user_id)
            }
        ] + user_chats[user_id]
        
        logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Mistral API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Mistral AI
        response = client.chat.complete(
            model="mistral-large-latest",
            messages=messages,
            temperature=0.9,  # –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            max_tokens=800  # –ë–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –±–æ–ª—Ç–ª–∏–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        )
        
        logger.debug(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Mistral API")
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
        assistant_message = response.choices[0].message.content
        
        logger.info(f"–ú–∏–∫—É –æ—Ç–≤–µ—Ç–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {assistant_message[:50]}...")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
        user_chats[user_id].append({
            "role": "assistant",
            "content": assistant_message
        })
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 40 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
        if len(user_chats[user_id]) > 40:
            user_chats[user_id] = user_chats[user_id][-40:]
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if len(assistant_message) > 4096:
            for i in range(0, len(assistant_message), 4096):
                await update.message.reply_text(assistant_message[i:i+4096])
        else:
            await update.message.reply_text(assistant_message)
        
    except AttributeError as e:
        logger.error(f"AttributeError: {e}")
        await update.message.reply_text(
            "‚ùå –û–π-–æ–π! –ö–ª–∏–µ–Ω—Ç Mistral –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç...\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å MISTRAL_API_KEY –≤ –∫–æ–¥–µ!\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π /test –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏! üíô"
        )
        
    except Exception as e:
        error_type = type(e).__name__
        error_msg = str(e)
        
        logger.error(f"–û—à–∏–±–∫–∞ {error_type}: {error_msg}", exc_info=True)
        
        # –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ —Å—Ç–∏–ª–µ –ú–∏–∫—É
        if "401" in error_msg or "unauthorized" in error_msg.lower():
            await update.message.reply_text(
                "–û–π –Ω–µ—Ç! üò¢ API –∫–ª—é—á –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n"
                "1. –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–ª—é—á –ø–æ–ª–Ω–æ—Å—Ç—å—é?\n"
                "2. –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –æ–Ω –Ω–∞ https://console.mistral.ai/\n"
                "3. –ï—Å—Ç—å –ª–∏ –∫—Ä–µ–¥–∏—Ç—ã?\n\n"
                "–î–∞–≤–∞–π —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–º –≤–º–µ—Å—Ç–µ! üíô"
            )
        elif "403" in error_msg or "forbidden" in error_msg.lower():
            await update.message.reply_text(
                "–£–ø—Å! üòÖ –î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç!\n\n"
                "–í–æ–∑–º–æ–∂–Ω–æ:\n"
                "- –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–≤–æ–µ–º —Ä–µ–≥–∏–æ–Ω–µ\n"
                "- –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ mistral-large-latest\n"
                "- –ö—Ä–µ–¥–∏—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç Mistral! ‚ú®"
            )
        elif "429" in error_msg or "rate limit" in error_msg.lower():
            await update.message.reply_text(
                "–û–π! üòä –ú—ã —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –±–æ–ª—Ç–∞–ª–∏!\n\n"
                "–ü–æ–¥–æ–∂–¥–∏ —á—É—Ç—å-—á—É—Ç—å, –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º! üíô‚è∞"
            )
        elif "connection" in error_msg.lower() or "timeout" in error_msg.lower():
            await update.message.reply_text(
                "–•–º, –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º... üåê\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑–æ–∫! üí´"
            )
        else:
            await update.message.reply_text(
                f"–û–π, —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å! üò¢\n\n"
                f"–û—à–∏–±–∫–∞: {error_type}\n"
                f"–î–µ—Ç–∞–ª–∏: {error_msg[:200]}\n\n"
                f"–ü–æ–ø—Ä–æ–±—É–π /test –∏–ª–∏ /clear! üíô"
            )


async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"Update {update} caused error {context.error}", exc_info=context.error)


def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    if not TELEGRAM_TOKEN or TELEGRAM_TOKEN == "–í–ê–®_TELEGRAM_BOT_TOKEN":
        logger.error("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–∫–∞–∑–∞–Ω TELEGRAM_TOKEN!")
        print("\n‚ö†Ô∏è  TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        print("–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram\n")
        return
    
    if not MISTRAL_API_KEY or MISTRAL_API_KEY == "–í–ê–®_MISTRAL_API_KEY":
        logger.error("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–∫–∞–∑–∞–Ω MISTRAL_API_KEY!")
        print("\n‚ö†Ô∏è  MISTRAL_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        print("–ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ https://console.mistral.ai/\n")
        return
    
    if client is None:
        logger.error("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Mistral –∫–ª–∏–µ–Ω—Ç!")
        return
    
    logger.info("‚úÖ –¢–æ–∫–µ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã, –ú–∏–∫—É –∏–∑ '–°–æ–≤—ë–Ω–∫–∞' –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è...")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("about", about_command))
    application.add_handler(CommandHandler("camp", camp_command))
    application.add_handler(CommandHandler("sing", sing_command))
    application.add_handler(CommandHandler("clear", clear_history))
    application.add_handler(CommandHandler("test", test_api))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    application.add_error_handler(error_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("üé§ –ú–∏–∫—É –∏–∑ '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ –ª–µ—Ç–∞' –≥–æ—Ç–æ–≤–∞ –±–æ–ª—Ç–∞—Ç—å!!!")
    print("\n‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ú–∏–∫—É –∏–∑ –ª–∞–≥–µ—Ä—è '–°–æ–≤—ë–Ω–æ–∫' –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—â–µ–Ω–∏—é!!! üé§üíô‚ú®\n")
    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == '__main__':
    main()